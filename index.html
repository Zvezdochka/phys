<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <script type="text/javascript" src="http://mbostock.github.com/d3/d3.v2.js?2.9.1"></script>

    <script type='text/javascript' src='phys/phys.js'></script>
    <script type='text/javascript' src='phys/body.js'></script>
    <script type='text/javascript' src='phys/behaviour/attraction.js'></script>    
    <script type='text/javascript' src='phys/behaviour/collision.js'></script>    
    <script type='text/javascript' src='phys/behaviour/boundbox.js'></script>    
    <script type='text/javascript' src='phys/math/vector.js'></script>    
    <script type='text/javascript' src='phys/math/point.js'></script>    
    <script type='text/javascript' src='images.js'></script>    
    
    <link rel="stylesheet" type="text/css" href="style1.css">
    <script>
        var reductor = 1;
        
        function init()
        {
            var phys = new Phys();    

            var cats = [phys.createBody('cat', 60, 200, 200),
                         ];

            var tapoks = [phys.createBody('tapok-1', 30, 600, 100),
                          phys.createBody('tapok-2', 30, 500, 500),
                          phys.createBody('tapok-3', 30, 150, 400)];

            tapoks[0].setExtantVelocityVector(phys.createVector(25, 5));

            var attract = function(b1, b2)
            {
                var force = phys.createAttractionBehaviour(b1, b2);
                b1.attachBehaviour(force);
                b2.attachBehaviour(force);
            }
            
            var collide = function(b1, b2)
            {
                var collision = phys.createCollisionBehaviour(b1, b2);
                b1.attachBehaviour(collision);
                b2.attachBehaviour(collision);
            }

            var wrapper = d3.select('#canvas');
            var boundBox = phys.createBoundBoxBehaviour(0, wrapper.node().clientHeight, wrapper.node().clientWidth, 0);
            cats[0].attachBehaviour(boundBox);
            tapoks[0].attachBehaviour(boundBox);
            tapoks[1].attachBehaviour(boundBox);
            tapoks[2].attachBehaviour(boundBox);

            attract(cats[0], tapoks[0]);
            attract(cats[0], tapoks[1]);
            attract(cats[0], tapoks[2]);

            collide(cats[0], tapoks[1]);
            collide(cats[0], tapoks[2]);
            collide(cats[0], tapoks[0]);
            collide(tapoks[0], tapoks[1]);
            collide(tapoks[1], tapoks[2]);
            collide(tapoks[2], tapoks[0]);

            phys.registerBody(cats[0]);
            phys.registerBody(tapoks[0]);
            phys.registerBody(tapoks[1]);
            phys.registerBody(tapoks[2]);

            d3.select('#makeStep').on('click', function() 
            { 
                d3.selectAll('.body_border').remove();

                phys.step(); 
                var stepNumber = phys.getStepNumber();
                d3.select('#stepNumber').text('Step number: '+ stepNumber);
            });

            var stepInterval = null;
            d3.select('#makeRun').on('click', function() 
            { 
                d3.selectAll('.body_border').remove();

                stepInterval = window.setInterval(function() 
                { 
                    phys.step(); 
                    var stepNumber = phys.getStepNumber();
                    d3.select('#stepNumber').text('Step number: '+ stepNumber);
                    if (stepNumber == 1853) 
                        {
                            return true;
                        }
                }, 1); 
            });

            d3.select('#makePause').on('click', function()
            {
                clearInterval(stepInterval);
                canvas.selectAll('.body_border.cat').data(cats).enter().insert('circle')
                    .attr('cx', function(d) {return d.getPos().x; })
                    .attr('cy', function(d) {return d.getPos().y; })
                    .attr('r', function(d) {return d.getMass(); })
                    .attr('class', 'body_border cat_border');

                canvas.selectAll('.body_border.tapok').data(tapoks).enter().insert('circle')
                    .attr('cx', function(d) {return d.getPos().x; })
                    .attr('cy', function(d) {return d.getPos().y; })
                    .attr('r', function(d) {return d.getMass(); })
                    .attr('class', 'body_border tapok_border');
            })

            var canvas = wrapper.append('svg');
            canvas.attr('width', wrapper.node().clientWidth)
                  .attr('height', wrapper.node().clientHeight);

            var defs = canvas.append('defs');
            defs.append('image')
                .attr('id', 'crazy_cat')
                .attr('xlink:href', getCatImageData())
                .attr('width', 120)
                .attr('height', 120)
                .attr('transform', 'scale(1, -1)');

            defs.append('image')
                .attr('id', 'tapok')
                .attr('xlink:href', getTapokImageData())
                .attr('width', 60)
                .attr('height', 60)
                .attr('transform', 'scale(1, -1)');

            canvas = canvas.append('g').attr('transform', 'translate(0, '+ wrapper.node().clientHeight +'),'+ 
                                                          'scale(1, -1)');

            canvas.selectAll('.cat').data(cats).enter().append('use')
                .attr('xlink:href', '#crazy_cat')
                .attr('class', 'cat')
                .attr('x', function(d) { return d.getPos().x-60;  })
                .attr('y', function(d) { return d.getPos().y+60; })
                /*.attr('r', function(d) { return d.getMass(); })*/
                .each(function(body)
                {
                    var bodyNode = d3.select(this);
                    body.onMoveBy(function(movement)
                    {
                        bodyNode
                            .attr('x', body.getPos().x-60)
                            .attr('y', body.getPos().y+60);
                    })
                });

            canvas.selectAll('.tapok').data(tapoks).enter().append('use')
                .attr('xlink:href', '#tapok')
                .attr('class', 'tapok')
                .attr('x', function(d) { return d.getPos().x-30;  })
                .attr('y', function(d) { return d.getPos().y+30; })
                /*.attr('r', function(d) { return d.getMass(); })*/
                .each(function(body)
                {
                    var bodyNode = d3.select(this);
                    body.onMoveBy(function(movement)
                    {
                        bodyNode
                            .attr('x', body.getPos().x-30)
                            .attr('y', body.getPos().y+30);
                    })
                });

        }
        window.addEventListener('load', init, false);
    </script>
</head>

<body>
    <div id='canvas'></div>
    <div id='panel'>
        <button id='makeStep'>step forward</button>
        <button id='makeStepBack' disabled="disabled">step back</button>
        <button id='makeRun'>run</button>
        <button id='makePause'>pause</button>
        <br>
        <div id='stepNumber'>Step number: 0</div>
    </div>
</body>
</html>
